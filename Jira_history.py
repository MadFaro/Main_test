UPDATE analytics.kdi_ipoteka_final_with_time_fix
SET DATE_BEGIN_CRIF_FIX = DATE_IN_WORK_FIX -
    (180 - ((EXTRACT(HOUR FROM CAST(DATE_BEGIN_CRIF_FIX AS TIMESTAMP)) - 17) * 60 + EXTRACT(MINUTE FROM CAST(DATE_BEGIN_CRIF_FIX AS TIMESTAMP))) +
    CASE 
        WHEN TO_CHAR(DATE_IN_WORK_FIX, 'Day', 'NLS_DATE_LANGUAGE = ''RUSSIAN''') IN ('Воскресенье', 'Суббота    ') THEN 
            (EXTRACT(HOUR FROM CAST(DATE_IN_WORK_FIX AS TIMESTAMP)) - 8) * 60 + EXTRACT(MINUTE FROM CAST(DATE_IN_WORK_FIX AS TIMESTAMP))
        ELSE 
            (EXTRACT(HOUR FROM CAST(DATE_IN_WORK_FIX AS TIMESTAMP)) - 7) * 60 + EXTRACT(MINUTE FROM CAST(DATE_IN_WORK_FIX AS TIMESTAMP))
    END) / 24 / 60
WHERE 
    EXTRACT(HOUR FROM (CAST(DATE_IN_WORK_FIX - DATE_BEGIN_CRIF_FIX AS TIMESTAMP) DAY TO SECOND)) > 2
    AND EXTRACT(HOUR FROM (CAST(DATE_IN_WORK_FIX - DATE_BEGIN_CRIF_FIX AS TIMESTAMP) DAY TO SECOND)) < 18
    AND EXTRACT(HOUR FROM CAST(DATE_BEGIN_CRIF_FIX AS TIMESTAMP)) >= 17
    AND 180 - ((EXTRACT(HOUR FROM CAST(DATE_BEGIN_CRIF_FIX AS TIMESTAMP)) - 17) * 60 + EXTRACT(MINUTE FROM CAST(DATE_BEGIN_CRIF_FIX AS TIMESTAMP))) +
    CASE 
        WHEN TO_CHAR(DATE_IN_WORK_FIX, 'Day', 'NLS_DATE_LANGUAGE = ''RUSSIAN''') IN ('Воскресенье', 'Суббота    ') THEN 
            (EXTRACT(HOUR FROM CAST(DATE_IN_WORK_FIX AS TIMESTAMP)) - 8) * 60 + EXTRACT(MINUTE FROM CAST(DATE_IN_WORK_FIX AS TIMESTAMP))
        ELSE 
            (EXTRACT(HOUR FROM CAST(DATE_IN_WORK_FIX AS TIMESTAMP)) - 7) * 60 + EXTRACT(MINUTE FROM CAST(DATE_IN_WORK_FIX AS TIMESTAMP))
    END < 180;
