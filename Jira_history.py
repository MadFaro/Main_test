CREATE OR REPLACE PROCEDURE p_service_level (
    p_dtmfrom DATE, 
    p_dtmto DATE, 
    p_departmentid NUMBER, 
    p_locale CHAR
) AS
BEGIN
    -- Создание временной таблицы
    EXECUTE IMMEDIATE 'CREATE GLOBAL TEMPORARY TABLE tmp_stats_service_level (
        id NUMBER GENERATED BY DEFAULT AS IDENTITY,
        threadid NUMBER NOT NULL,
        department_id NUMBER,
        got_into_common_queue_time DATE NOT NULL,
        start_chatting_time DATE NOT NULL,
        PRIMARY KEY(id)
    ) ON COMMIT DELETE ROWS';
    
    -- Очистка временной таблицы
    EXECUTE IMMEDIATE 'TRUNCATE TABLE tmp_stats_service_level';

    -- Вставка данных во временную таблицу
    INSERT INTO tmp_stats_service_level (threadid, department_id, got_into_common_queue_time, start_chatting_time)
    WITH chat_data AS (
        SELECT
            cth.threadid,
            cth.departmentid,
            cth.state,
            cth.dtm,
            LEAD(cth.state) OVER (PARTITION BY cth.threadid ORDER BY cth.number) AS next_state,
            LEAD(cth.dtm) OVER (PARTITION BY cth.threadid ORDER BY cth.number) AS next_dtm
        FROM chatthreadhistory cth
        JOIN chatthread ct ON ct.threadid = cth.threadid
        WHERE ct.offline = 0
        AND cth.dtm BETWEEN p_dtmfrom AND p_dtmto
    ),
    chat_queue AS (
        SELECT
            threadid,
            departmentid,
            dtm AS got_into_common_queue_time,
            next_dtm AS start_chatting_time
        FROM chat_data
        WHERE state = 'queue' AND next_state = 'chatting'
    )
    SELECT
        threadid,
        departmentid,
        got_into_common_queue_time,
        start_chatting_time
    FROM chat_queue;

    -- Коммит изменений (для глобальной временной таблицы)
    COMMIT;
END;
/
