CREATE TABLE analytics.tolog_cr_new_product_live AS
SELECT 
    b.CONTRACT_UID, b.ACC_NUM, b.CONTRACT_NUM, 
    CASE WHEN b.ACC_CLOSE_DT IS NULL THEN SYSDATE ELSE b.ACC_CLOSE_DT END AS ACC_CLOSE_DT, 
    b.ACC_OPEN_DT, b.STATUS_NM,
    a.CLIENT_ID, a.CLIENT_DID,a.REPORT_MONTH, a.PIL, 
    a.AUTO, a.MORT, a.CONTRACT_CC, a.CONTRACT_OVER, 
    a.CREDIT_CARD, a.DEBIT_CARD, a.DC_CL, a.TERM_DEPOSIT, 
    a.DVS, a.REPAYMENT_ANNUITET, a.CURRENT_ACCOUNT, a.REPAYMENT_CC, 
    a.IS_NTB, a.CLIENT_SEGMENT, a.RETAIL_SEG, a.PRIOR_PRODUCT, a.MACROFILIAL
FROM (
    SELECT 
        a.*, 
        ROW_NUMBER() OVER (PARTITION BY a.CLIENT_DID ORDER BY a.REPORT_MONTH DESC) AS rn
    FROM analytics.finalta_3_0_full a
    WHERE TRUNC(a.REPORT_MONTH, 'mm') >= DATE'2022-01-01' AND a.PRIOR_PRODUCT = 'Кредитная карта'
) a
LEFT JOIN dm.contracts b ON a.client_did = b.client_did AND b.PRODUCT_CATEGORY_NM = 'Кредитная карта' AND b.ACC_OPEN_DT IS NOT NULL
WHERE a.rn = 1

