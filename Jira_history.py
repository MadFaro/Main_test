WITH Events AS (
    SELECT 
        TO_CHAR(EVENT_TIME, 'YYYY-MM-DD') AS EVENT_DATE,
        EVENT_TYPE_ID,
        EVENT_TIME,
        LEAD(EVENT_TIME) OVER (PARTITION BY CALL_ID ORDER BY RANK) AS NEXT_EVENT_TIME
    FROM your_table
),
MenuDurations AS (
    SELECT 
        EVENT_DATE,
        EVENT_TYPE_ID,
        SUM(CASE 
            WHEN NEXT_EVENT_TIME IS NOT NULL THEN (NEXT_EVENT_TIME - EVENT_TIME) * 24 * 60 * 60 
            ELSE 0 
        END) AS TOTAL_TIME_SPENT,
        COUNT(*) AS EVENT_COUNT
    FROM Events
    GROUP BY EVENT_DATE, EVENT_TYPE_ID
),
MenuCounts AS (
    SELECT 
        TO_CHAR(EVENT_TIME, 'YYYY-MM-DD') AS EVENT_DATE,
        EVENT_TYPE_ID,
        COUNT(DISTINCT CALL_ID) AS CALL_COUNT
    FROM your_table
    GROUP BY TO_CHAR(EVENT_TIME, 'YYYY-MM-DD'), EVENT_TYPE_ID
),
AvgMenuTime AS (
    SELECT 
        EVENT_DATE,
        EVENT_TYPE_ID,
        TOTAL_TIME_SPENT / EVENT_COUNT AS AVG_TIME_SPENT
    FROM MenuDurations
)
SELECT 
    MC.EVENT_DATE,
    MC.EVENT_TYPE_ID,
    MC.CALL_COUNT,
    MD.TOTAL_TIME_SPENT,
    AMT.AVG_TIME_SPENT
FROM MenuCounts MC
LEFT JOIN MenuDurations MD ON MC.EVENT_DATE = MD.EVENT_DATE AND MC.EVENT_TYPE_ID = MD.EVENT_TYPE_ID
LEFT JOIN AvgMenuTime AMT ON MC.EVENT_DATE = AMT.EVENT_DATE AND MC.EVENT_TYPE_ID = AMT.EVENT_TYPE_ID
ORDER BY MC.EVENT_DATE, MC.EVENT_TYPE_ID;
